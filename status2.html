<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Status Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap">
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-5xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold text-gray-800">服務狀態 <span id="header-status" class="text-2xl font-semibold text-black bg-gray-100 rounded-full">連線中</span></h1>
      <!-- <span id="overall-status" class="text-gray-500 bg-gray-100 px-3 py-1 rounded-full text-sm font-semibold">連線中</span> -->
      <span id="last-refresh" class="text-gray-500 bg-gray-100 px-3 py-1 rounded-full text-sm font-semibold">上次更新時間：連線中</span>
    </div>

    <!-- Status Overview -->
   <h2 class="text-lg font-semibold mb-4">服務狀態
      <small>可用: ✔️, 不可用: ❌, 錯誤: ⚠️</small>
   </h2>
    <p id="last-refresh" class="text-sm text-gray-500 mb-4">上次更新時間：連線中</p>

    <!-- Status Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- 動態生成卡片 -->
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    const fileId = '1cU8zT0_JrjgTOavNWLDKnHpzMKEqcxWn';
    const url = `https://script.google.com/macros/s/AKfycby0KdnH9pes7G5HLWgmpVBlXX0Ezi-IY5Iueg7mwVg20W0Irt-jw5Nd4YS0JgqqPf4/exec?fileId=${fileId}`;

    const statusMap = {
      AVAILABLE: { color: "green", icon: "✔️", label: "可用" },
      UNAVAILABLE: { color: "red", icon: "❌", label: "不可用" },
      ERROR: { color: "yellow", icon: "⚠️", label: "錯誤" },
    };

    function fetchAndRender() {
      document.getElementById("header-status").textContent = "連線中";
      document.getElementById("last-refresh").textContent = "上次更新時間：連線中";
      document.getElementById("last-refresh").className = "text-gray-500 bg-gray-100 px-3 py-1 rounded-full text-sm font-semibold";

      fetch(url)
        .then(response => response.text())
        .then(data => {
          const parsedData = Papa.parse(data, {
            header: true,
            dynamicTyping: true
          }).data;

          
          // 更新上次刷新時間
          const now = new Date();
          document.getElementById("last-refresh").textContent = `上次更新時間：${now.toLocaleString()}`;
          
          const allServicesAreNormal = renderCards(parsedData);
          document.getElementById("header-status").textContent = allServicesAreNormal ? "正常" : "異常";
          document.getElementById("last-refresh").textContent = `上次更新時間：${now.toLocaleString()}`;
          //document.getElementById("last-refresh").className = allServicesAreNormal
          //  ? "text-green-500 bg-green-100 px-3 py-1 rounded-full text-sm font-semibold"
          //  : "text-red-500 bg-red-100 px-3 py-1 rounded-full text-sm font-semibold";
        })
        .catch(error => {
          console.error('讀取或解析 CSV 文件時發生錯誤:', error);
        });
    }

    function renderCards(data) {
      const container = document.querySelector(".grid");
      container.innerHTML = "";

      let allServicesAreNormal = true;

      data.forEach((item) => {
        const service = item["service name"] || "未定義服務";
        const status = item["status"] || "未知";
        const updatetime = new Date(item["updatetime"]);
        const period = item["period"] || 0;

        // 計算是否超過允許時間範圍
        const now = new Date();
        const isError = now - updatetime > period * 60 * 1000;

        const displayStatus = isError ? "ERROR" : status;
        if (isError) {
          allServicesAreNormal = false;
        }

        const { color, icon, label } = statusMap[displayStatus] || { color: "gray", icon: "❔", label: "未知" };

        const card = document.createElement("div");
        card.className = `p-4 border rounded-lg shadow-sm hover:shadow-md transition`;

        card.innerHTML = `
          <div class="flex items-center justify-between">
            <h3 class="text-gray-700 font-semibold">${service}</h3>
            <div class="text-${color}-500 text-2xl">${icon}</div>
          </div>
          <span class="text-sm bg-${color}-100 text-${color}-700 px-2 py-1 rounded-full font-medium inline-block mt-2">
            ${label}
          </span>
          <p class="text-gray-500 text-sm mt-1">最後更新: ${updatetime.toLocaleString()}</p>
        `;

        container.appendChild(card);
      });

      return allServicesAreNormal;
    }

    // 初始化頁面
    fetchAndRender();

    // 每分鐘更新一次
    setInterval(fetchAndRender, 60000);
  </script>
</body>
</html>
