<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Status Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap">
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-5xl">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold text-gray-800">服務狀態 <span id="header-status" class="text-black">連線中</span></h1>
      <span id="overall-status" class="text-gray-500 bg-gray-100 px-3 py-1 rounded-full text-sm font-semibold">連線中</span>
    </div>

    <!-- Status Overview -->
    <h2 class="text-lg font-semibold mb-4">總體狀態</h2>

    <!-- Status Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- 動態生成卡片 -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@dojo/framework@7.0.6/dist/dojo/dojo.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const fileId = '1zqvU7QwcYATY4DnUH1GsuFnhPunQMI4A';
      const url = `https://script.google.com/macros/s/AKfycbzuZTVtv2fK_qVFfoE4_1EbN5f5_mB6XVxhTe-VAqkX6nYWd2aEayFQhsLlb69acXhR4Q/exec?fileId=${fileId}`;

      const statusMap = {
        AVAILABLE: { color: "green", icon: "✔️", label: "可用" },
        UNAVAILABLE: { color: "red", icon: "❌", label: "不可用" },
        ERROR: { color: "yellow", icon: "⚠️", label: "錯誤" },
      };

      async function fetchAndRender() {
        const headerStatus = document.getElementById("header-status");
        const overallStatus = document.getElementById("overall-status");

        if (headerStatus) {
          headerStatus.textContent = "連線中";
        }

        if (overallStatus) {
          overallStatus.textContent = "連線中";
          overallStatus.className = "text-gray-500 bg-gray-100 px-3 py-1 rounded-full text-sm font-semibold";
        }

        try {
          const response = await fetch(url);
          const text = await response.text();
          const parsedData = parseCSVWithDojo(text);

          const allServicesAreNormal = renderCards(parsedData);

          if (headerStatus) {
            headerStatus.textContent = allServicesAreNormal ? "正常" : "異常";
          }

          if (overallStatus) {
            overallStatus.textContent = allServicesAreNormal ? "正常" : "異常";
            overallStatus.className = allServicesAreNormal
              ? "text-green-500 bg-green-100 px-3 py-1 rounded-full text-sm font-semibold"
              : "text-red-500 bg-red-100 px-3 py-1 rounded-full text-sm font-semibold";
          }
        } catch (error) {
          console.error('讀取或解析 CSV 文件時發生錯誤:', error);
        }
      }

      function parseCSVWithDojo(csvText) {
        const rows = csvText.split('\\n').filter(row => row.trim() !== "");
        const header = rows[0].split(',').map(h => h.trim());
        const data = rows.slice(1).map(row => {
          const values = row.split(',').map(v => v.trim());
          return header.reduce((acc, key, index) => {
            acc[key] = values[index];
            return acc;
          }, {});
        });
        return data;
      }

      function renderCards(data) {
        const container = document.querySelector(".grid");
        container.innerHTML = "";

        let allServicesAreNormal = true;

        data.forEach((item) => {
          const service = item["service name"] || "未定義服務";
          const status = item["status"] || "未知";
          const updatetime = new Date(item["updatetime"]);
          const period = item["period"] || 0;

          const now = new Date();
          const isError = now - updatetime > period * 60 * 1000;

          const displayStatus = isError ? "ERROR" : status;
          if (isError) {
            allServicesAreNormal = false;
          }

          const { color, icon, label } = statusMap[displayStatus] || { color: "gray", icon: "❔", label: "未知" };

          const card = document.createElement("div");
          card.className = `p-4 border rounded-lg shadow-sm hover:shadow-md transition`;

          card.innerHTML = `
            <div class="flex items-center justify-between">
              <h3 class="text-gray-700 font-semibold">${service}</h3>
              <div class="text-${color}-500 text-2xl">${icon}</div>
            </div>
            <span class="text-sm bg-${color}-100 text-${color}-700 px-2 py-1 rounded-full font-medium inline-block mt-2">
              ${label}
            </span>
            <p class="text-gray-500 text-sm mt-1">最後更新: ${updatetime.toLocaleString()}</p>
          `;

          container.appendChild(card);
        });

        return allServicesAreNormal;
      }

      fetchAndRender();
      setInterval(fetchAndRender, 60000);
    });
  </script>
</body>
</html>
